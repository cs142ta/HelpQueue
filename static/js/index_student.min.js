var timeout,poll=!1,alertShown=!1,currentSpotInLine=-1,addressBase="",pauseUpdate=!1,spot="-1",flashTitleBool=!1;setInterval(function(){if(poll&&enqueueTime>10){var e=currentlyGettingHelp?"Time Spent With TA: ":"Time Waiting: ",t=getTimeDifference(parseInt(enqueueTime));$("#timeWaitingLabel").html(e),$("#timeWaiting").html(t)}else $("#timeWaiting").html(""),$("#timeWaitingLabel").html("");if($("#refreshText").empty(),!poll){var n=getTimeDifference(parseInt(refreshTime));$("#refreshText").append("<li>Time since this page was last refreshed: "+n+"</li>")}},1e3);var chat=new Chat(!1);$(function(){chat.getState(),$("#sendie").keydown(function(e){if(e.which>=33){var t=$(this).attr("maxlength");this.value.length>=t&&e.preventDefault()}}),$("#sendie").keyup(function(e){if(13==e.keyCode){var t=$(this).val(),n=$(this).attr("maxlength");t.length<=n+1?(chat.send(t,user),$(this).val("")):$(this).val(t.substring(0,n))}}),$("#close-chat").click(function(e){chat.close(user)}),setInterval("chat.update()",1e3)});var helpButtonHandle="/queueUp.php";function getCurrentHelpButtonAction(){return helpButtonHandle}function getTimeDifference(e){var t=new Date(e),n=((new Date).getTime()-t.getTime())/1e3;return parseInt(n/3600)+"h:"+parseInt(n%3600/60)+"m:"+parseInt(n%3600%60)+"s"}function verifyStudentInputToggleButton(){if($("#getHelpButton").removeClass("btn-danger"),$("#getHelpButton").removeClass("btn-warning"),$("#getHelpButton").removeClass("btn-success"),$(".noQuestionRequiredButtons").removeClass("btn-danger"),$(".noQuestionRequiredButtons").removeClass("btn-warning"),$(".noQuestionRequiredButtons").removeClass("btn-success"),$(".noQuestionRequiredButtons").removeClass("btn-info"),queueActive){var e=$("#questionInput").val(),t=$("#passOffCheckBox").prop("checked");removeSpinner("getHelpButton"),removeSpinner("getHelpButtonNoQuestion"),removeSpinner("passOffButtonNoQuestion"),console.log(e),e.length>0&&"invalid"!=$("#roomSelector").val()||t?($("#getHelpButton").removeAttr("disabled"),$("#getHelpButton").html("Get in line for help")):($("#getHelpButton").attr("disabled","disabled"),$("#getHelpButton").html("Enter a question")),$("#getHelpButtonNoQuestion").addClass("btn-success"),$("#passOffButtonNoQuestion").addClass("btn-info"),$("#getHelpButtonNoQuestion").html("Get Help"),$("#passOffButtonNoQuestion").html("Pass Off"),$("#questionInput").removeAttr("disabled"),$("#passOffCheckBox").removeAttr("disabled"),$("#getHelpButton").addClass("btn-success"),$("#queueNum").html("You are not currently in line"),$("#questionInputLengthLeft").html(200-e.length+" characters remaining")}else $("#getHelpButton").addClass("btn-warning"),$("#getHelpButton").html("The Help Queue is not currently active"),$("#queueNum").html("Go the TA lab to get help"),$("#getHelpButton").attr("disabled","disabled"),$("#getHelpButtonNoQuestion").attr("disabled","disabled"),$("#passOffButtonNoQuestion").attr("disabled","disabled"),$("#getHelpButtonNoQuestion").addClass("btn-warning"),$("#getHelpButtonNoQuestion").html("The Help Queue is not currently active"),$("#passOffButtonNoQuestion").addClass("btn-warning"),$("#passOffButtonNoQuestion").html("The Help Queue is not currently active"),$("#questionInput").attr("disabled","disabled"),$("#passOffCheckBox").attr("disabled","disabled")}function showNotification(){"undefined"!=typeof Notification?Notification.requestPermission(function(e){"granted"===e&&(new Notification("It is almost your turn to get help!",{body:"Go to the TA Lab to get help!",tag:"MyNotify"}).onclick=function(){window.focus()});alert("It is almost your turn to get help!")}):alert("It is almost your turn to get help!")}function showChatNote(){var e="New chat session opened!";"undefined"!=typeof Notification?Notification.requestPermission(function(t){"granted"===t&&(new Notification(e,{body:"A TA has something to tell you!",tag:"MyNotify"}).onclick=function(){window.focus()});alert(e)}):alert(e)}function updateUI(e){if(e.hasOwnProperty("settings")&&$.each(e.settings,function(e,t){$.each(t,function(e,t){$("#"+e).html(t),$("#"+e).prop("checked","true"==t),"courseTitle"===e&&(null==t||""==t?$("#courseNameChangeModal").modal({backdrop:"static",keyboard:!1}):($("#courseTitle").empty(),$("#courseTitle").html(t),$("#courseTitleField").empty(),$("#courseTitleField").html(t),originalTitle=t+" Help Queue",document.title=t+" Help Queue")),"notifyThreshold"===e&&(notifyThresholdNum=t,$("#notifyThresholdPostFix").empty(),$("#notifyThresholdPostFix").html(getNumberPostFix(t))),"queueActive"===e&&(queueActive="true"==t,"false"==t&&($("#questionInput").attr("disabled","disabled"),$("#passOffCheckBox").attr("disabled","disabled"))),"passOffHighlightColor"==e&&($("#currentPassOffHighlightColor").css("color",t),currentPassOffHighlightColor=t),"lastXMin"==e&&($(".lastXMin").empty(),$(".lastXMin").html(t)),"requireQuestion"==e&&("true"==t?($("#questionsRequired").show(),$("#questionsNotRequired").hide()):($("#questionsRequired").hide(),$("#questionsNotRequired").show()))})}),e.hasOwnProperty("status")&&"loggedOut"===e.status)window.location.href="/?logout=";else if(e.hasOwnProperty("status")&&"error"===e.status)e.hasOwnProperty("message")?(alert("ERROR: "+e.message),helpButtonHandle="/queueUp.php",poll=!1,currentSpotInLine=-1,$("#questionInput").removeAttr("disabled"),$("#passOffCheckBox").removeAttr("disabled"),$("#passOffCheckBox").prop("checked",!1),verifyStudentInputToggleButton()):alert("Error with the error");else if(e.hasOwnProperty("spot")&&e.hasOwnProperty("enqueueTime")){if(0==pauseUpdate)if(spot=e.spot,enqueueTime=null==e.startedGettingHelpTime?e.enqueueTime:e.startedGettingHelpTime,currentlyGettingHelp=null!=e.startedGettingHelpTime,spot<=notifyThresholdNum&&parseInt(spot)>=0&&null==e.startedGettingHelpTime&&(alertShown||currentSpotInLine==spot||flashTitleBool||(flashTitleBool=!0,flashTitle("Its almost your turn to get help!"),showNotification())),parseInt(spot)<0)helpButtonHandle="/queueUp.php",poll=!1,currentSpotInLine=-1,$("#questionInput").removeAttr("disabled"),$("#passOffCheckBox").removeAttr("disabled"),$("#passOffButtonNoQuestion").removeAttr("disabled"),$("#getHelpButtonNoQuestion").removeAttr("disabled"),flashTitleBool&&$("#questionInput").val(""),$("#passOffCheckBox").prop("checked",!1),verifyStudentInputToggleButton(),flashTitleBool=!1;else{if($("#getHelpButton").removeClass("btn-success"),$("#passOffButtonNoQuestion").removeClass("btn-warning"),$("#getHelpButtonNoQuestion").removeClass("btn-warning"),$("#getHelpButton").addClass("btn-danger"),$("#passOffButtonNoQuestion").addClass("btn-info"),$("#getHelpButtonNoQuestion").addClass("btn-success"),removeSpinner("passOffButtonNoQuestion"),removeSpinner("getHelpButtonNoQuestion"),"true"==e.passOff?($("#getHelpButtonNoQuestion").attr("disabled","disabled"),$("#passOffButtonNoQuestion").removeAttr("disabled"),$("#passOffButtonNoQuestion").removeClass("btn-info"),$("#getHelpButtonNoQuestion").removeClass("btn-success"),$("#passOffButtonNoQuestion").addClass("btn-danger"),null==e.startedGettingHelpTime?($("#passOffButtonNoQuestion").html("Get out of line"),$("#getHelpButtonNoQuestion").html("You are in line to pass off")):($("#passOffButtonNoQuestion").html("Be done getting help"),$("#getHelpButtonNoQuestion").html("You are currently being helped"))):($("#passOffButtonNoQuestion").attr("disabled","disabled"),$("#getHelpButtonNoQuestion").removeAttr("disabled"),$("#getHelpButtonNoQuestion").removeClass("btn-success"),$("#passOffButtonNoQuestion").removeClass("btn-info"),$("#getHelpButtonNoQuestion").addClass("btn-danger"),null==e.startedGettingHelpTime?($("#passOffButtonNoQuestion").html("You are in line to get help"),$("#getHelpButtonNoQuestion").html("Get out of line")):($("#getHelpButtonNoQuestion").html("Be done getting help"),$("#passOffButtonNoQuestion").html("You are currently being helped"))),null==e.startedGettingHelpTime){var t=getNumberPostFix(spot);$("#getHelpButton").html("Get out of line"),$("#queueNum").html("You are currently the <strong>"+spot+t+"</strong> in line to get help")}else $("#getHelpButton").html("Done getting help"),$("#queueNum").html("<strong>You are currently being helped</strong>");helpButtonHandle="/removeFromQueue.php",removeSpinner("getHelpButton"),poll=!0,currentSpotInLine=spot,$("#questionInput").attr("disabled","disabled"),$("#passOffCheckBox").attr("disabled","disabled"),e.hasOwnProperty("question")&&$("#questionInput").val(e.question),e.hasOwnProperty("passOff")&&$("#passOffCheckBox").prop("checked","true"==e.passOff)}}else e.hasOwnProperty("stats")&&($("#statsList").empty(),$("#taList").empty(),$.each(e.stats.tas,function(e,t){var n='<div class="row myRow" id="'+t.netId+'"><div class="col-xs-2">'+(1==t.active?"TA":"TA (non-active)")+'</div><div class="col-xs-3">'+t.netId+'</div><div class="col-xs-3">'+t.name+'</div><div class="col-xs-2">'+t.helpCounter+'</div><div class="col-xs-2">'+t.passOffCounter+"</div></div>";$("#statsList").append(n);var o='<div class="row myRow" id="'+t.netId+'"><div class="col-xs-3">'+t.netId+'</div><div class="col-xs-3">'+t.name+'</div><div class="col-xs-2">'+t.helpCounter+'</div><div class="col-xs-2">'+t.passOffCounter+'</div><div class="col-xs-2">  <input id="'+t.netId+'ActiveToggle" type="checkbox" onchange="toggleTAActive(\''+t.netId+"',"+t.active+')"'+(1==t.active?"checked":"")+"></input>  <button onclick=\"editTAName('"+t.netId+'\')" class="btn btn-sm btn-warning fa fa-edit" style="margin-left:5px; margin-top:-5px;"></button></div>';$("#taList").append(o)}),$("#statsList").append("<hr>"),$.each(e.stats.students,function(e,t){var n='<div class="row myRow" id="'+t.netId+'"><div class="col-xs-2">Student</div><div class="col-xs-3">'+t.netId+'</div><div class="col-xs-3">'+t.name+'</div><div class="col-xs-2">'+t.helpCounter+'</div><div class="col-xs-2">'+t.passOffCounter+"</div></div>";$("#statsList").append(n)}));e.hasOwnProperty("avgs")&&($("#topCount").empty(),$("#topAvg").empty(),$("#queueLen").empty(),$("#currentlyBeingHelped").empty(),$("#enqueueInLastXMin").empty(),$("#dequeueInLastXMin").empty(),$("#topCount").append(e.avgs.avgLen),$("#queueLen").append(e.avgs.queueLen),e.avgs.avg>10?$("#topAvg").append(getTimeDifference(e.avgs.avg)):$("#topAvg").append("0"),e.avgs.hasOwnProperty("currentlyBeingHelpedCount")&&$("#currentlyBeingHelped").append(e.avgs.currentlyBeingHelpedCount),e.avgs.hasOwnProperty("enqueueInLastXMin")&&$("#enqueueInLastXMin").append(e.avgs.enqueueInLastXMin),e.avgs.hasOwnProperty("dequeueInLastXMin")&&$("#dequeueInLastXMin").append(e.avgs.dequeueInLastXMin))}function convertNetIdToName(e){for(person in globalTas)if(globalTas[person].netId==e)return globalTas[person].name;return globalStudentNames[e]}function convertNumDateToName(e){return["January","February","March","April","May","June","July","August","September","October","November","December"][(e=new Date(e)).getMonth()]+"-"+e.getDate()+"-"+e.getFullYear()}function formatOutputDateAMPM(e,t,n){var o=e.getMonth()+1,s=e.getDate(),a=e.getFullYear(),i=e.getHours(),l=e.getMinutes(),u=e.getSeconds(),r=i>=12?"pm":"am";i=(i%=12)||12,l=pad(l),u=pad(u);var d="";return t&&(d+=o+"/"+s+"/"+a+" "),n&&(d+=i+":"+l+":"+u+" "+r),d}function pad(e){return("0"+e).slice(-2)}$(function(){originalTitle=document.title,window.flashTitle=function(e,t){t=parseInt(t),isNaN(t)&&(t=5),cancelFlashTitle(timeout),function t(){document.title=document.title==originalTitle?e:originalTitle,flashTitleBool?timeout=setTimeout(t,1e3):document.title=originalTitle}()},window.cancelFlashTitle=function(){clearTimeout(timeout),document.title=originalTitle},setInterval(function(){poll&&getStatus(user)},pollTimer),setInterval(function(){getStatus(user)},6e5);for(var e=window.location.pathname.split("/"),t=0;t<e.length-1;t++)addressBase+=e[t],t<e.length-2&&(addressBase+="/");$('[data-toggle="tooltip"]').tooltip(),verifyStudentInputToggleButton(),$("#questionInput").on("input",verifyStudentInputToggleButton),$("#passOffCheckBox").on("click",verifyStudentInputToggleButton),$("#roomSelector").on("change",verifyStudentInputToggleButton),$("#getHelpButton").on("click",function(){var e=$("#questionInput").val(),t=$("#passOffCheckBox").is(":checked"),n=$("#roomSelector").val();e.length<0&&0==t&&!poll?alert("Please enter a question or click pass off"):"invalid"!=n?($("#questionInput").attr("disabled","disabled"),$("#passOffCheckBox").attr("disabled","disabled"),spin("getHelpButton"),function(e,t,n){poll=!0,pauseUpdate=!0;postData({username:e,question:t,passOff:n},getCurrentHelpButtonAction(),function(e){pauseUpdate=!1,updateUI(e),getNameStatus()},function(e){pauseUpdate=!1,console.log(e),$("#questionInput").removeAttr("disabled"),$("#passOffCheckBox").removeAttr("disabled"),$("#passOffButtonNoQuestion").removeAttr("disabled"),$("#getHelpButtonNoQuestion").removeAttr("disabled"),getStatus(userName,!1),alert("You must have been busy! You waited so long BYU automatically logged you out!")})}(user,n+" - "+e,t)):parseInt(spot)<0||alert("Please choose a room number")}),$("#nameSubmit").on("click",function(){var e=$("#nameInput").val();if(e.length<=0)alert("Please enter a name");else if(e.match(/[^A-Za-z ]+/))alert("Only alphabetic characters are allowed");else{$("#nameChangeModal").modal("hide");var t={name:e};$("#nameInput").val(""),postData(t,"/editNames.php",function(e){"noname"==e.status&&$("#nameChangeModal").modal({backdrop:"static",keyboard:!1})},function(e){console.log(e)})}}),$("#stats").hide(),$("#editTAs").hide(),$("#viewSettings").hide(),$("#extendedStats").hide(),$("#editRawData").hide(),$("#viewQueue").on("click",function(){toggleView("#queue")}),$("#viewStats").on("click",function(){toggleView("#stats")}),$("#viewAddTa").on("click",function(){toggleView("#editTAs")}),$("#settings").on("click",function(){toggleView("#viewSettings")}),$("#extendedStatsButton").on("click",function(){toggleView("#extendedStats")}),$("#editRawDataButton").on("click",function(){toggleView("#editRawData")}),"undefined"!=typeof user&&(getStatus(user),getNameStatus());var n=window.alert;window.alert=function(){alertShown=!0,n.apply(window,arguments),alertShown=!1}});var tempSpot=5;function removePerson(e){var t={username:e};spin("removeButton"+e);postData(t,"/removeFromQueue.php",function(t){removeSpinner("removeButton"+e),updateUI(t)},function(e){console.log(e)})}function dequeuePerson(e){var t={username:e};spin("removeButton"+e);postData(t,"/finishHelping.php",function(t){removeSpinner("removeButton"+e),updateUI(t)},function(e){console.log(e)})}function getNumberPostFix(e){var t="th";switch(e%10){case 1:11!=e&&(t="st");break;case 2:12!=e&&(t="nd");break;case 3:13!=e&&(t="rd");break;default:t="th"}return t}function spin(e){$("#"+e).attr("disabled","disabled");e=document.getElementById(e);spinner=(new Spinner).spin(e)}function removeSpinner(e){$("#"+e).removeAttr("disabled"),"undefined"!=typeof spinner&&spinner.stop()}function getNameStatus(){$.ajax({url:addressBase+"/editNames.php",type:"get",dataType:"json",success:function(e){e.hasOwnProperty("name")&&null==e.name&&$("#nameChangeModal").modal({backdrop:"static",keyboard:!1}),console.log(e)},error:function(e){console.log(e)}})}function getStatus(e,t){$.ajax({url:addressBase+"/getStatus.php?id="+e,type:"get",dataType:"json",success:function(e){refreshTime=(new Date).getTime(),updateUI(e)},error:function(n){console.log(n),(t=void 0===t||t)&&getStatus(e,!1)}})}function postData(e,t){postData(e,t,function(e){console.log("Post complete"),console.log(e),updateUI(e)},function(e){console.log(e)})}function postData(e,t,n,o){$.ajax({url:window.location.origin+addressBase+t,type:"post",dataType:"json",success:n,error:o,data:e})}function chatWith(e,t){console.log("Opened chat"),(chat=new Chat(e)).notify(user),chat.enter(user),$("#chat-title").html("Chat with: "+t),$("#chatModal").modal({backdrop:"static",keyboard:!1})}function stuChat(){showChatNote(),($("#chatModal").data("bs.modal")||{}).isShown||(chat.clear(),chat.enter(user),$("#chatModal").modal({backdrop:"static",keyboard:!1}))}
